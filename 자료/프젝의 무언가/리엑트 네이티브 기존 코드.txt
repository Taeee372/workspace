import axios from 'axios';
import { useRouter } from 'expo-router';
import { useCallback, useEffect, useState } from 'react';
import { Alert, ScrollView, StyleSheet, Switch, Text, View } from 'react-native';
import Button from '../../../components/Button';
import { RefreshControl } from 'react-native';


const ManualControl = () => {
  const router = useRouter();

  const [controlMode, setControlMode] = useState({
    door: 'auto',
    humPen: 'auto',
    airPen: 'auto',
    led: 'auto'
  });

  const [refreshing, setRefreshing] = useState(false);

  const [isEnabled, setIsEnabled] = useState({
    door : false,
    humPen : false,
    airPen : false,
    led : false
  });

  const [sensorData, setSensorData] = useState({
    temperature: '-',
    humidity: '-',
    lux: '-',
    co2 : '-'
  });
  
  const toggleSwitch = async (device) => {
    // ğŸ”¥ ìë™ ëª¨ë“œë©´ ë¨¼ì € ìˆ˜ë™ ëª¨ë“œë¡œ ì „í™˜
    if (controlMode[device] === 'auto') {
      try {
        const statusRes = await axios.get('http://192.168.30.240:5000/api/status', {
          timeout: 5000
        });
        
        if(statusRes.data && statusRes.data.controls){
          // ì‹¤ì œ ìƒíƒœë¡œ UI ë™ê¸°í™”
          setIsEnabled(prev => ({
            ...prev,
            [device]: statusRes.data.controls[device]
          }));
        }
        
        // ìˆ˜ë™ ëª¨ë“œë¡œ ì „í™˜
        setControlMode(prev => ({
          ...prev,
          [device]: 'manual'
        }));
        
        Alert.alert('ìˆ˜ë™ ëª¨ë“œ', 'ìˆ˜ë™ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.\në‹¤ì‹œ ìŠ¤ìœ„ì¹˜ë¥¼ ì¡°ì‘í•´ì£¼ì„¸ìš”.');
        console.log(`${device} ìˆ˜ë™ ëª¨ë“œë¡œ ì „í™˜ë¨`);
        return; // ì—¬ê¸°ì„œ ì¢…ë£Œ
      } catch(e) {
        console.log(e);
        Alert.alert('ì˜¤ë¥˜', 'ìƒíƒœë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        return;
      }
    }
    
    // ğŸ”¥ ì´ë¯¸ ìˆ˜ë™ ëª¨ë“œë©´ ì •ìƒ ì œì–´
    const newState = !isEnabled[device];

    setIsEnabled(prev => ({
      ...prev,
      [device] : newState
    }));

    try {
      await axios.post('http://192.168.30.240:5000/api/control', {
        device : device,
        state : newState,
        mode : 'manual'
      }, {
        timeout : 5000
      })
      
      setControlMode(prev => ({
        ...prev,
        [device]: 'manual'
      }));
      
      console.log(`${device} ${newState ? 'ON' : 'OFF'} ì„±ê³µ`);

    }catch(e){
      console.log(e);

      setIsEnabled(prev => ({
        ...prev,
        [device]: !newState
      }));
      
      Alert.alert('ì œì–´ ì‹¤íŒ¨', 'ê¸°ê¸° ì œì–´ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  }

  // ìë™ ëª¨ë“œë¡œ ì „í™˜
  const setAutoMode = async (device) => {
    try {
      await axios.post('http://192.168.30.240:5000/api/control', {
        device: device,
        mode: 'auto'
      }, {
        timeout: 5000
      });
      
      setControlMode(prev => ({
        ...prev,
        [device]: 'auto'
      }));
      
      console.log(`${device} ìë™ ëª¨ë“œë¡œ ì „í™˜`);
    } catch(e) {
      console.log(e);
    }
  }

  const getEnv = async () => {
    try{
      const res = await axios.get('http://192.168.30.240:5000/api/realtime');
      const data = res.data.data;
      setSensorData({
        temperature : data.temperature,
        humidity : data.humidity,
        lux : data.lux,
        co2 : data.co2
      });

      const statusRes = await axios.get('http://192.168.30.240:5000/api/status', {
        timeout: 5000
      });
      
      if(statusRes.data && statusRes.data.controls){
        setIsEnabled(statusRes.data.controls);
        console.log('í˜„ì¬ ìƒíƒœ:', statusRes.data.controls);
      }

      if(statusRes.data && statusRes.data.modes){
        setControlMode(statusRes.data.modes);
        console.log('í˜„ì¬ ëª¨ë“œ:', statusRes.data.modes);
      }
    }catch(e){
      console.log(e);
    }
  }

  const onRefresh = useCallback(async () => {
    setRefreshing(true);
    await getEnv();
    setRefreshing(false);
  }, [])

  useEffect(() => {
   getEnv();
  }, [])

  return (
    <ScrollView
      refreshControl={
        <RefreshControl 
          refreshing={refreshing} 
          onRefresh={onRefresh}
        />
      }
    >
      <View>
        <View style={styles.control}>
          <View style={styles.manual}>
            <Text>ì˜¨ë„</Text>
            <Text>{sensorData.temperature}</Text>
            <Text>ë¬¸ ì œì–´</Text>
            <Switch 
              trackColor={{false : '#b9b8b9ff', true : '#87b3ffff'}}
              thumbColor={isEnabled.door ? '#1e6df5ff' : '#767577'}
              onValueChange={() => toggleSwitch('door')}
              value={isEnabled.door}
            />
          </View>
          <Button 
            title='ìë™'
            onPress={() => setAutoMode('door')}
          />
        </View>
        <View style={styles.control}>
          <View style={styles.manual}>
            <Text>ìŠµë„</Text>
            <Text>{sensorData.humidity}</Text>
            <Text>íŒ¬ ê°€ë™</Text>
            <Switch 
              trackColor={{false : '#b9b8b9ff', true : '#87b3ffff'}}
              thumbColor={isEnabled.humPen ? '#1e6df5ff' : '#767577'}
              onValueChange={() => toggleSwitch('humPen')}
              value={isEnabled.humPen}
            />
          </View>
          <Button 
            title='ìë™'
            onPress={() => setAutoMode('humPen')}
          />
        </View>
        <View style={styles.control}>
          <View style={styles.manual}>
            <Text>CO2</Text>
            <Text>{sensorData.co2}</Text>
            <Text>íŒ¬ ê°€ë™</Text>
            <Switch 
              trackColor={{false : '#b9b8b9ff', true : '#87b3ffff'}}
              thumbColor={isEnabled.airPen ? '#1e6df5ff' : '#767577'}
              onValueChange={() => toggleSwitch('airPen')}
              value={isEnabled.airPen}
            />
          </View>
          <Button 
            title='ìë™'
            onPress={() => setAutoMode('airPen')}
          />
        </View>
        <View style={styles.control}>
          <View style={styles.manual}>
            <Text>ì¡°ë„</Text>
            <Text>{sensorData.lux}</Text>
            <Text>ì¡°ëª…</Text>
            <Switch 
              trackColor={{false : '#b9b8b9ff', true : '#87b3ffff'}}
              thumbColor={isEnabled.led ? '#1e6df5ff' : '#767577'}
              onValueChange={() => toggleSwitch('led')}
              value={isEnabled.led}
            />
          </View>
          <Button 
            title='ìë™'
            onPress={() => setAutoMode('led')}
          />
        </View>
        <Button title='ìë™ ì œì–´ ì„¤ì •' onPress={() => router.push('/control/AutoControl')}/>

      </View>
    </ScrollView>
  )
}

export default ManualControl

const styles = StyleSheet.create({
  control : {
    flexDirection : 'row',
    gap : 10,
    justifyContent : 'space-around',
    alignItems : 'center',
    marginVertical : 20
  },
  manual : {
    flexDirection : 'row',
    alignItems : 'center',
    gap : 30
  }
})